#!/usr/bin/env bash
set -euo pipefail

# Wrapper script for PyLucene search via Docker

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# Check Docker availability
if ! command -v docker >/dev/null 2>&1; then
    echo "Error: Docker is required. Please install Docker." >&2
    exit 1
fi

# Parse arguments
QUERY=""
QUERY_TYPE="simple"
TOP=10
SEARCH_ARGS=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --query|-q)
            QUERY="$2"
            shift 2
            ;;
        --type|-t)
            QUERY_TYPE="$2"
            shift 2
            ;;
        --top|-n)
            TOP="$2"
            shift 2
            ;;
        --field)
            SEARCH_ARGS="$SEARCH_ARGS --field $2"
            shift 2
            ;;
        --min-value)
            SEARCH_ARGS="$SEARCH_ARGS --min-value $2"
            shift 2
            ;;
        --max-value)
            SEARCH_ARGS="$SEARCH_ARGS --max-value $2"
            shift 2
            ;;
        --slop)
            SEARCH_ARGS="$SEARCH_ARGS --slop $2"
            shift 2
            ;;
        --max-edits)
            SEARCH_ARGS="$SEARCH_ARGS --max-edits $2"
            shift 2
            ;;
        --json)
            SEARCH_ARGS="$SEARCH_ARGS --json"
            shift
            ;;
        *)
            shift
            ;;
    esac
done

if [[ -z "${QUERY}" ]]; then
    echo "Usage: $0 --query \"search terms\" [--type simple|boolean|range|phrase|fuzzy] [--top N]"
    echo ""
    echo "Examples:"
    echo "  $0 --query \"python web framework\" --type simple"
    echo "  $0 --query \"python AND docker\" --type boolean"
    echo "  $0 --query \"machine learning\" --type phrase"
    echo "  $0 --query \"pyhton\" --type fuzzy"
    echo "  $0 --query \"\" --type range --field star_count --min-value 1000"
    exit 1
fi

echo "========================================"
echo "PyLucene Search"
echo "========================================"
echo "Query: ${QUERY}"
echo "Type: ${QUERY_TYPE}"
echo "Top: ${TOP}"
echo "========================================"

# Run via Docker Compose
cd "${PROJECT_ROOT}"
docker compose run --rm \
    -e QUERY="${QUERY}" \
    -e QUERY_TYPE="${QUERY_TYPE}" \
    -e TOP="${TOP}" \
    -e SEARCH_ARGS="${SEARCH_ARGS}" \
    lucene-search
